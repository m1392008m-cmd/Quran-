<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المسابقة الدينية الكبرى</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #27ae60; --error: #e74c3c; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #quiz-card { background: white; width: 90%; max-width: 600px; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .question-text { font-size: 1.4rem; font-weight: bold; margin-bottom: 1.5rem; color: var(--primary); }
        .options-grid { display: grid; gap: 10px; }
        .btn-opt { padding: 15px; border: 2px solid #ddd; border-radius: 10px; background: none; cursor: pointer; font-size: 1.1rem; transition: all 0.2s; }
        .btn-opt:hover:not(:disabled) { border-color: var(--secondary); background: #f0fff4; }
        .correct { background-color: var(--secondary) !important; color: white; border-color: var(--secondary) !important; }
        .wrong { background-color: var(--error) !important; color: white; border-color: var(--error) !important; }
        .stats { display: flex; justify-content: space-between; margin-bottom: 1rem; color: #7f8c8d; font-weight: bold; }
        #loader { font-size: 1.2rem; color: var(--primary); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="quiz-card">
    <div id="loader">جاري معالجة قاعدة البيانات...</div>
    
    <div id="game-zone" class="hidden">
        <div class="stats">
            <span>السؤال: <span id="q-count">1</span> / 15</span>
            <span>النتيجة: <span id="score">0</span></span>
        </div>
        <div id="question" class="question-text"></div>
        <div id="options" class="options-grid"></div>
    </div>

    <div id="result-zone" class="hidden">
        <h2 id="final-msg">أحسنت!</h2>
        <p style="font-size: 1.5rem;">لقد أجبت على <span id="final-score">0</span> من 15</p>
        <button onclick="location.reload()" style="padding: 10px 25px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">إعادة الاختبار</button>
    </div>
</div>

<script>
    let allData = [];
    let currentPool = [];
    let currentIndex = 0;
    let score = 0;

    // دالة لمعالجة الملف المشوه (تجاوز أخطاء JSON)
    async function loadAndFixData() {
        try {
            const response = await fetch('ans.json');
            const rawText = await response.text();
            
            // استخدام Regex لاستخراج الأجسام {} حتى لو كانت المصفوفات مكسورة
            const regex = /{[^{}]*}/g;
            const matches = rawText.match(regex);
            
            if (!matches) throw new Error("الملف فارغ أو غير صالح");

            let uniqueMap = new Map();
            matches.forEach(m => {
                try {
                    let q = JSON.parse(m);
                    // فلترة التكرار بناءً على نص السؤال لضمان عدم تكرار "السحور" وغيره
                    if (!uniqueMap.has(q.question)) {
                        uniqueMap.set(q.question, q);
                    }
                } catch(e) {}
            });

            allData = Array.from(uniqueMap.values());
            startNewGame();

        } catch (err) {
            document.getElementById('loader').innerText = "خطأ: تأكد من وجود ملف ans.json بجانب صفحة الـ HTML.";
            console.error(err);
        }
    }

    function startNewGame() {
        // خلط البيانات وسحب 15 سؤال عشوائي
        currentPool = allData.sort(() => 0.5 - Math.random()).slice(0, 15);
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        if (currentIndex >= 15) return showEnd();
        
        const q = currentPool[currentIndex];
        document.getElementById('q-count').innerText = currentIndex + 1;
        document.getElementById('question').innerText = q.question;
        
        const optionsDiv = document.getElementById('options');
        optionsDiv.innerHTML = '';

        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn-opt';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(btn, opt, q.answer);
            optionsDiv.appendChild(btn);
        });
    }

    function checkAnswer(btn, selected, correct) {
        const btns = document.querySelectorAll('.btn-opt');
        btns.forEach(b => b.disabled = true);

        if (selected === correct) {
            btn.classList.add('correct');
            score++;
            document.getElementById('score').innerText = score;
        } else {
            btn.classList.add('wrong');
            btns.forEach(b => { if(b.innerText === correct) b.classList.add('correct'); });
        }

        setTimeout(() => {
            currentIndex++;
            showQuestion();
        }, 1500);
    }

    function showEnd() {
        document.getElementById('game-zone').classList.add('hidden');
        document.getElementById('result-zone').classList.remove('hidden');
        document.getElementById('final-score').innerText = score;
        document.getElementById('final-msg').innerText = score > 10 ? "ممتاز! معلوماتك قوية" : "محاولة جيدة، اقرأ أكثر!";
    }

    loadAndFixData();
</script>
</body>
</html>
